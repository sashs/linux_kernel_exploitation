#include <linux/compiler.h>
#include <linux/fs.h>
#include <linux/kernel.h>
#include <linux/miscdevice.h>
#include <linux/module.h>
#include <linux/uaccess.h>


MODULE_DESCRIPTION("vuln1 buffer overflow");
MODULE_AUTHOR("sashs");
MODULE_LICENSE("GPL");

#define IOCTL_VULN_WRT 4141

static int vuln1_open(struct inode *inode, struct file *file)
{
	return 0;
}

static int vuln1_release(struct inode *inodep, struct file *filp)
{
	return 0;
}

static noinline int vuln1_do_breakstuff(unsigned long addr)
{
	char buffer[256];
	volatile int size = 512;

	return _copy_from_user(&buffer, (void __user *)addr, size);
}

static long vuln1_ioctl(struct file *fd, unsigned int cmd, unsigned long value)
{
	long to_return;

	switch (cmd) {
		case IOCTL_VULN_WRT:
			to_return = vuln1_do_breakstuff(value);
			break;
		default:
			to_return = -EINVAL;
			break;
	}

	return to_return;
}

static const struct file_operations vuln1_fops = {
	.owner		= THIS_MODULE,
	.open		= vuln1_open,
	.unlocked_ioctl = vuln1_ioctl,
	.release	= vuln1_release,
	.llseek 	= no_llseek,
};

struct miscdevice vuln1_device = {
	.minor	= MISC_DYNAMIC_MINOR,
	.name	= "vuln",
	.mode	= S_IRUGO | S_IWUGO,
	.fops	= &vuln1_fops,
};

module_misc_device(vuln1_device);
